<style lang="less">
.zm-input {
  border: 1px solid rgb(240, 240, 240);
  border-radius: 4px;
}
.image-list {
    display: flex;
    justify-content: center;
    box-sizing: border-box;
    padding: 15px;
    padding-top: 0;
    width: 100%;
    background: #FFF;
    overflow: hidden;

    .choosed-image-list {
      position: relative;
      float: left;
      width: 70px;
      height: 70px;
      margin-right: 15px;
      margin-top: 15px;

      .choosed-image {
        width: 100%;
        height: 100%;
      }

      .choosed-image-delete-btn {
        position: absolute;
        right: -10px;
        top: -10px;
        width: 20px;
        height: 20px;
      }

      .choosed-image-delete-btn-icon {
        width: 20px;
        height: 20px;
      }
    }

    .choose-image-btn {
      float: left;
      width: 70px;
      height: 70px;
      margin-top: 15px;

      .choose-image-btn-icon {
        width: 70px;
        height: 70px;
      }
    }
  }
  .zm-invite {
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 50px 0;
    text {
      padding-bottom:10px; font-weight: 700;
    }
    button {
      margin-top:10px;
    }
  }
  .zm-edit-container {
    margin: 10px;
    height: 100%;
    box-shadow: 0 2px 12px 0 rgba(0,0,0,.1);
    border: 1px solid #e6ebf5;
    border-radius: 10px;
    box-shadow:inset 0 2px 12px 0 rgba(0,0,0,.1);
  }
  .green {
    color: green;
  }
</style>
<template>
  <view class="container zm-edit-container" style="padding: 20px;">

    <view wx:if="{{!accessible}}">
      <view class="zm-invite" wx:if="{{!accessible}}">
        <text style="">è¯·è¾“å…¥ä½ çš„é‚€è¯·ç </text>
        <input bindinput="editinvite" class="zm-input" placeholder="æ¬¢è¿ä½ ..." auto-focus/>
        <button bindtap="inviteGuest" style="" type="primary" name="button">ç¡®å®š</button>
      </view>
    </view>

    <view wx:if="{{accessible}}">
      <view style="padding: 20px; text-align:center; display: flex; flex-direction:column; ">
        <text style="font-size: 30px;font-weight:700;color: #c0ae7d">è¯·è¯¦ç»†å¡«å†™èµ„æ–™</text>
        <text style="font-size: 12px; color: green; opacity: 0.5;">(ç»¿è‰²éƒ¨åˆ†ä¸ºå¿…å¡«)</text>
      </view>

      <view>
        <view>
          <text class="green">è¯·ä¸Šä¼ ä¸€åˆ°ä¸‰å¼ å…å† ç…§</text>
          <view class="image-list">
            <!-- preview the image which already be choosed -->
            <view
              class="choosed-image-list"
              wx:for="{{ images }}"
              wx:for-item="image"
              wx:for-index="idx"
              wx:key="{{ idx }}">
              <image
                src="{{ image }}"
                mode="aspectFill"
                @tap.stop="previewImage({{ image }}, {{ images }})"
                class="choosed-image"></image>
              <view
                class="choosed-image-delete-btn"
                @tap.stop="deleteImage({{ idx }})">
                <image
                  class="choosed-image-delete-btn-icon"
                  src="../img/delete.svg"></image>
              </view>
            </view>
            <!-- image choosing btn -->
            <view
              class="choose-image-btn"
              wx:if="{{ images.length < 3 }}"
              bindtap="chooseImage">
              <image
                class="choose-image-btn-icon"
                src="../img/choose-image.svg">
              </image>
            </view>
          </view>
        </view>

        <view style="display: flex; padding-bottom:10px;">
          <text class="green">æ˜µç§°ï¼š</text>
          <input bindinput="editnickname" class="zm-input" placeholder="åœ¨è¿™é‡Œè®¤è¯†æœ‹å‹..."/>
        </view>

        <view>
          <text style="">è¯·åšä¸€ä¸ªè‡ªæˆ‘ä»‹ç»: </text>
          <textarea bindinput="editselfintro" class="zm-input" style="height: 100px;margin-top:10px;" bindblur="bindTextAreaBlur" placeholder="ç›¸é‡ç›¸çŸ¥..." />
        </view>

        <view style="padding: 10px 0;">
          <text class="green">æ€§åˆ«:</text>
          <radio-group style="padding-top:10px;" bindchange="editgender">
            <label class="radio" wx:for="{{gender}}" wx:key="{{ idx }}" wx:for-index="idx">
              <radio value="{{item}}" checked="{{item.checked}}"/>{{item}}
            </label>
          </radio-group>
        </view>

        <view style="display: flex; padding-bottom:10px;">
          <text class="green">å¹´é¾„ï¼š</text>
          <input class="zm-input" bindinput="editage" type="number" placeholder="æ‰¾åˆ°å–œæ¬¢çš„äºº..."/>
        </view>

        <view style="padding-bottom:10px;">
          <!-- <view class="">å©šå§»çŠ¶æ€</view> -->
          <picker bindchange="editMarriageStatus" value="{{marriageStatusIndex}}" range="{{marriageStatusRange}}">
            <view class="picker">
              <text class="green">å©šå§»çŠ¶æ€ï¼š</text>{{marriageStatusRange[marriageStatusIndex]}}
            </view>
          </picker>
        </view>

        <view style="display: flex; padding-bottom:10px;">
          <text class="green">èº«é«˜(cm)ï¼š</text>
          <input class="zm-input" bindinput="editheight" type="number" placeholder="ä¸€ç”Ÿä¸€ä¸–..."/>
        </view>

        <view style="display: flex; padding-bottom:10px;">
          <text>ä½“é‡(Kg)ï¼š</text>
          <input class="zm-input" bindinput="editweight" type="number" placeholder="äººç”Ÿç™¾å¹´..."/>
        </view>

        <view style="padding-bottom:10px;">
          <!-- <view class="">å©šå§»çŠ¶æ€</view> -->
          <picker style="padding-bottom:10px;" bindchange="degreeChoose" value="{{degreeIndex}}" range="{{degreeRange}}">
            <view class="picker">
              <text class="green">å­¦å†ï¼š</text>{{degreeRange[degreeIndex]}}
            </view>
          </picker>
          <view style="padding-bottom:10px;">
            <text>æµ·å½’æ´¾ï¼š</text>
            <checkbox bindtap="edithaigui"/>
          </view>
          <view style="padding-bottom:10px;">
            <text>æ¯•ä¸šé™¢æ ¡ï¼š</text>
            <input class="zm-input" bindinput="editcollege" style="margin-top: 5px;" placeholder="è«ä¸å¦‚æ­¤ä¸ºæœ€ç¾..."/>
          </view>
          <view style="">
            <text>ä¸“ä¸šï¼š</text>
            <input class="zm-input" bindinput="editmajor" style="margin-top: 5px;" placeholder="è‹¥å¤šä¸ªå¯ä»¥åŠ é€—å·åˆ†åˆ«åˆ—å‡º..."/>
          </view>
        </view>

        <view style="padding-bottom:10px;">
          <text>å·¥ä½œ/å­¦ä¹ åŸå¸‚ï¼ˆåªé™å—äº¬ï¼‰</text>
          <input placeholder="å—äº¬" disabled/>
        </view>

        <view style="padding-bottom:10px;">
          <picker bindchange="editSalary" value="{{salaryIndex}}" range="{{salaryRange}}">
            <view class="picker">
              è–ªæ°´ï¼š{{salaryRange[salaryIndex]}}
            </view>
          </picker>
        </view>

        <view style="display: flex; padding-bottom:10px;">
          <text>æ˜¯å¦æœ‰æˆ¿ï¼š</text>
          <checkbox bindtap="edityoufang"/>
        </view>

        <view style="display: flex; padding-bottom:10px;">
          <text>æˆ·å£ï¼š</text>
          <input class="zm-input" bindchange="edithometown" placeholder="æ¯”å¦‚å—äº¬..."/>
        </view>

        <view style="display: flex; padding-bottom:10px;">
          <text>ä»äº‹è¡Œä¸šï¼š</text>
          <input class="zm-input" bindchange="editindustry" placeholder="æ¯”å¦‚äº’è”ç½‘..."/>
        </view>

        <view style="display: flex; padding-bottom:10px;">
          <text>å…¬å¸ç±»å‹ï¼š</text>
          <input class="zm-input" bindchange="editcompanytype" placeholder="æ¯”å¦‚æœºå…³å•ä½..."/>
        </view>

    </view>
      <button style="margin: 10px 0;" bindtap="send" type="primary" name="button">ç¡®å®šä¸Šä¼ </button>
    </view>
  </view>
</template>

<script>
  import wepy from 'wepy'
  import api from './../api/api'

  export default class Edit extends wepy.page {
    config = {
      navigationBarTitleText: 'ç¼–è¾‘'
    };
    data = {
      invitecode: '',
      marriageStatusIndex: 0,
      degreeIndex: 0,
      salaryIndex: 0,
      genderValue: '',
      accessible: true,
      selfintro: '',
      age: 0,
      height: 0,
      weight: 0,
      gender: ['å¥³ç”Ÿ', 'ç”·ç”Ÿ'],
      images: [],
      nickname: '',
      college: '',
      major: '',
      shihaigui: false,
      youfang: false,
      hometown: '',
      industry: '',
      companytype: '',
      marriageStatusRange: ['æœªé€‰æ‹©', 'æœªå©š', 'ç¦»å¼‚'],
      degreeRange: ['æœªé€‰æ‹©', 'æœ¬ç§‘', 'ç¡•å£«', 'åšå£«'],
      haigui: false,
      salaryRange: ['æœªé€‰æ‹©', 'åœ¨è¯»', '2 ~ 5K', '5 ~ 10K', '10 ~ 20K', '20 ~ 50K', '50Kä»¥ä¸Š']
    };
    methods = {
      async send () {
        var self = this
        // æ£€æŸ¥å¿…å¡«é¡¹
        if (self.nickname.length > 0 && self.gender.length > 0 && self.degreeIndex !== 0 && self.height.length > 0 && self.marriageStatusIndex !== 0 && self.age.length > 0) {
          wepy.showModal({
            title: 'æç¤º',
            content: 'ç¡®å®šä¸Šä¼ å—ï¼Ÿåªæ­¤ä¸€æ¬¡ä¸Šä¼ æœºä¼šé¢ï¼Œå› ä¸ºç¾¤ä¸»æœ‰ç‚¹å¿™ï¼Œæš‚æ—¶æ²¡æœ‰ä¿®æ”¹çš„åŠŸèƒ½çš„å‘¢ã€‚ä¿®æ”¹æš‚æ—¶åªèƒ½æ‰¾æ³½é“­ä»åå°å®ŒæˆğŸ˜œã€‚'
          }).then(async function (res) {
            if (res.confirm) {
              console.log(self)
                // imgUrls: []

              var imgUrls = []
                // upload images
              if (self.images.length > 0) {
                try {
                  for (let v of self.images) {
                    const r = await wepy.uploadFile({
                      url: 'http://127.0.0.1:9000/api/upload/image',
                      filePath: v,
                      name: 'file',
                      success: function(res) {
                        console.log('image has been successfully saved in server. Congrats!')
                      }
                    })

                    r.data = JSON.parse(r.data)
                    if (r.data.img) {
                      imgUrls.push(r.data.img)
                    } else {
                      wepy.hideToast()
                      wepy.showModal({
                        title: 'æç¤º',
                        content: 'æœåŠ¡å™¨é”™è¯¯ï¼Œä¸Šä¼ å›¾ç‰‡å¤±è´¥ã€‚è¯·é‡è¯•~ï¼šï¼‰' + r.data.errmsg,
                        showCancel: false
                      })
                    }
                  }
                } catch (e) {
                  wepy.hideToast()
                  wepy.showModal({
                    title: 'æç¤º',
                    content: 'æœåŠ¡å™¨é”™è¯¯ï¼Œä¸Šä¼ å›¾ç‰‡å¤±è´¥ã€‚' + e.message,
                    showCancel: false
                  })
                  return
                }
              }

              // update portfolio
              var pack = {
                invitecode: self.invitecode,
                imgUrls: imgUrls,
                nickname: self.nickname,
                selfintro: self.selfintro,
                gender: self.genderValue,
                age: self.age,
                marriagestatus: self.marriageStatusRange[self.marriageStatusIndex],
                height: self.height,
                weight: self.weight,
                degree: self.degreeRange[self.degreeIndex],
                shihaigui: self.shihaigui,
                college: self.college,
                major: self.major,
                city: 'å—äº¬',
                salary: self.salaryRange[self.salaryIndex],
                youfang: self.youfang,
                hometown: self.hometown,
                industry: self.industry,
                companytype: self.companytype
              }

              try {
                const res = await api.newportfolio({
                  query: {
                    pack: pack
                  },
                  method: 'POST'
                })
                // console.log('data back from new blog: ' + JSON.stringify(res))
                wepy.hideToast()
                if (res.data.success) {
                  await wepy.showToast({
                    title: 'å‘é€æˆåŠŸï¼',
                    icon: 'success',
                    duration: 1500,
                    mask: true
                  })
                  wepy.setStorageSync('_uploaded', true)
                } else {
                  wepy.showModal({
                    title: 'æç¤º',
                    content: 'æŠ±æ­‰ï¼ŒæœåŠ¡å™¨å‘ç”Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»æ³½é“­: takeiteasydude',
                    showCancel: false
                  })
                }

                wepy.navigateTo({
                  url: 'main'
                })
              } catch (e) {
                wepy.hideToast()
                wepy.showModal({
                  title: 'æç¤º',
                  content: 'æŠ±æ­‰ï¼ŒæœåŠ¡å™¨å‘ç”Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»æ³½é“­: takeiteasydudeã€‚',
                  showCancel: false
                })
                return e
              }
            }
          })
        } else {
          wepy.showModal({
            title: 'æç¤º',
            content: 'è¯·æŠŠç»¿è‰²æç¤ºå¿…å¡«çš„å†…å®¹è¡¥é½é¢^_^...'
          })
        }
      },
      edityoufang (e) {
        this.youfang = !this.youfang
      },
      edithaigui (e) {
        this.shihaigui = !this.shihaigui
      },
      editgender (e) {
        this.genderValue = e.detail.value
      },
      editcompanytype (e) {
        this.companytype = e.detail.value
      },
      editindustry (e) {
        this.industry = e.detail.value
      },
      edithometown (e) {
        this.hometown = e.detail.value
      },
      editmajor (e) {
        this.major = e.detail.value
      },
      editcollege (e) {
        this.college = e.detail.value
      },
      editweight (e) {
        var temp = e.detail.value
        if (temp.length > 3) {
          wepy.showModal({
            title: 'æç¤º',
            content: 'Are you kidding me... åˆ«ä»¥ä¸ºæ³½é“­ä¸çŸ¥é“ï¼Œå“¼ï¼'
          })
        } else {
          if (isNaN(temp)) {
            wepy.showModal({
              title: 'æç¤º',
              content: 'è¯·è¾“å…¥æ•°å­—...'
            })
          } else {
            this.weight = e.detail.value
          }
        }
      },
      editheight (e) {
        var temp = e.detail.value
        if (temp.length > 3) {
          wepy.showModal({
            title: 'æç¤º',
            content: 'Are you kidding me... åˆ«ä»¥ä¸ºæ³½é“­ä¸çŸ¥é“ï¼Œå“¼ï¼'
          })
        } else {
          if (isNaN(temp)) {
            wepy.showModal({
              title: 'æç¤º',
              content: 'è¯·è¾“å…¥æ•°å­—...'
            })
          } else {
            this.height = e.detail.value
          }
        }
      },
      editage (e) {
        var temp = e.detail.value

        if (temp.length > 2) {
          wepy.showModal({
            title: 'æç¤º',
            content: 'Are you kidding me... åˆ«ä»¥ä¸ºæ³½é“­ä¸çŸ¥é“ï¼Œå“¼ï¼'
          })
        } else {
          if (isNaN(temp)) {
            wepy.showModal({
              title: 'æç¤º',
              content: 'è¯·è¾“å…¥æ•°å­—...'
            })
          } else {
            this.age = e.detail.value
          }
        }
      },
      editselfintro (e) {
        if (e.detail.value.length < 120) {
          this.selfintro = e.detail.value
        } else {
          wepy.showModal({
            title: 'æç¤º',
            content: 'ä½ å·²è¶…å‡ºå­—æ•°èŒƒå›´...'
          })
        }
      },
      editnickname (e) {
        if (e.detail.value.length < 10) {
          this.nickname = e.detail.value
        } else {
          wepy.showModal({
            title: 'æç¤º',
            content: 'ä½ å·²è¶…å‡ºå­—æ•°èŒƒå›´...'
          })
        }
      },
      editSalary (e) {
        this.salaryIndex = e.detail.value
      },
      degreeChoose (e) {
        this.degreeIndex = e.detail.value
      },
      editMarriageStatus (e) {
        this.marriageStatusIndex = e.detail.value
      },
      async inviteGuest () {
        if (this.invitecode.length === 0) {
          wepy.showModal({
            title: 'æç¤º',
            content: 'æŠ±æ­‰ï¼Œé‚€è¯·ç ä¸èƒ½ä¸ºç©ºã€‚',
            showCancel: false
          })
        } else {
          wepy.showToast({
            title: 'éªŒè¯ä¸­...',
            icon: 'loading',
            duration: 10000,
            mask: true
          })
          var self = this
          console.log(typeof self.invitecode)
          const res = await api.verifyinvite({
            query: {
              invitecode: self.invitecode
            },
            method: 'POST'
          })
          console.log(res)
          wepy.hideToast()
          if (res.data && res.data.available) {
            wepy.showToast({
              title: 'æˆåŠŸ',
              icon: 'success',
              duration: 2000
            })
            this.accessible = true
            self.$apply()
          } else {
            wepy.showModal({
              title: 'æç¤º',
              content: 'æŠ±æ­‰ï¼Œé‚€è¯·ç æ— æ³•è¯†æˆ–è€…å·²å¤±æ•ˆï¼Œè¯·é‡æ–°è¾“å…¥æœ‰æ•ˆé‚€è¯·ç ã€‚',
              showCancel: false
            })
          }
        }
      },
      editinvite (e) {
        this.invitecode = e.detail.value
      },
      bindTextAreaBlur: function(e) {
        console.log(e.detail.value)
      },
      async chooseImage () {
        const { tempFilePaths } = await wepy.chooseImage({
          count: 3 - this.images.length,
          sizeType: 'compressed'
        })
        this.images.push(...tempFilePaths)
        this.$apply()
      },
      previewImage (cur, imageList) {
        wepy.previewImage({
          current: cur,
          urls: imageList
        })
      },
      deleteImage (idx) {
        this.images.splice(idx, 1)
        this.$apply()
      }
    }
  }
</script>
